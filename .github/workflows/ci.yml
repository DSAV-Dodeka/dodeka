name: CI

on:
  push:
    branches: [ main ]
  pull_request:
  release:
    types: [ published ]

jobs:
  config-deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}
      - run: pipx install poetry==1.3.0
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'poetry'
      - run: poetry install
      # Build config using tiptenbrink/confspawn
      - name: Config
        run: |
          poetry run confrecipe -r build/deploy/staging/staging.toml -e staging
          poetry run confrecipe -r build/deploy/dev/dev.toml -e localdev
      - uses: stefanzweifel/git-auto-commit-action@v4
        if: github.event_name != 'pull_request'
        with:
          commit_message: Config build (automated)
          file_pattern: use/

  build_db:
    # if: ${{ false }}
    strategy:
      matrix:
        target: ['staging', 'production']
    uses: DSAV-Dodeka/dodeka/.github/workflows/db.yml@main
    with:
      env: ${{ matrix.target }}

  build_server:
    # if: ${{ false }}
    strategy:
      matrix:
        target: [ 'staging', 'production' ]
    uses: DSAV-Dodeka/dodeka/.github/workflows/server.yml@main
    with:
      env: ${{ matrix.target }}
    secrets:
      GH_DODEKACOMCOM_TOKEN: ${{ secrets.GH_DODEKACOMCOM_TOKEN }}

  build_kv:
    # if: ${{ false }}
    strategy:
      matrix:
        target: [ 'staging', 'production' ]
    uses: DSAV-Dodeka/dodeka/.github/workflows/kv.yml@main
    with:
      env: ${{ matrix.target }}
      
