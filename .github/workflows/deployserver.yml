name: Deploy server

on: workflow_dispatch

jobs:
 deploy:
   runs-on: ubuntu-latest

   env:
     SECRETS_PASSPHRASE: ${{ secrets.SECRETS_PASSPHRASE }}
     GHCR_TOKEN: ${{ github.token }}
     ACTOR: ${{ github.actor }}

   steps:
   - uses: actions/checkout@v2
   # Third party GH Action, pinned to commit for security
   - name: executing remote ssh commands using ssh key
     uses: appleboy/ssh-action@1a8b3784eaa665f677fa114edd5683bb6a6bfaa8
     with:
       host: "116.203.107.52"
       username: "backend"
       key: ${{ secrets.SSH_HETZNER_PRIVATE_KEY }}
       port: 22
       envs: SECRETS_PASSPHRASE,GHCR_TOKEN,ACTOR
       script_stop: true
       # This requires poetry, docker, gpg, bash to be installed on remote
       # Also requires GH CLI logged in with an account with repo read access
       script: |
         echo $GHCR_TOKEN | docker login ghcr.io -u $ACTOR --password-stdin
         export DEPLOYID="$(date +%s)"
         gh repo clone DSAV-Dodeka/dodeka ~/serverdeployments/deploy$DEPLOYID
         gh repo clone DSAV-Dodeka/secrets ~/serverdeployments/secrets$DEPLOYID
         cd ~/serverdeployments/secrets$DEPLOYID
         set -a
         . decrypt.sh secretdb.env.gpg $SECRETS_PASSPHRASE
         . decrypt.sh secretserver.env.gpg $SECRETS_PASSPHRASE
         cd ~/serverdeployments/deploy$DEPLOYID/use
         ./deploykv/deploy.sh move
         ./deployserver/deploy.sh move